SELECT DISTINCT WEEK,
       LEVEL,
       storekeeper_id,
       VEHICLE,
       CITY       
FROM (SELECT DISTINCT 
	DATE_TRUNC('week', o.created_at::DATE) AS week,
	o.order_id,
	o.country,
	d.storekeeper_id,
	IFNULL(s.level_name, 'rookie') AS level,
      VEHICLE,
      EMAIL.CITY,
      email
FROM
	global_finances.global_orders o
	JOIN global_finances.global_order_details d
	ON o.order_id = d.order_id AND o.country = d.country
	LEFT JOIN (
	
		SELECT
			'BR' AS country,
			s.storekeeper_id,
			s.created_at::TIMESTAMP_NTZ AS starts_at,
			LEAD(starts_at, 1, CURRENT_TIMESTAMP::TIMESTAMP_NTZ) OVER (PARTITION BY s.storekeeper_id ORDER BY s.created_at) AS ends_at,
			l.level_name
		FROM
			br_pg_ms_sk_score_history_public.sk_level s
			LEFT JOIN br_pg_ms_sk_score_history_public.level l
			ON s.level_id = l.id
		QUALIFY
			ends_at::DATE >= '2020-10-05'
				
		) s
	ON o.country = s.country AND d.storekeeper_id = s.storekeeper_id AND o.created_at::TIMESTAMP_NTZ BETWEEN s.starts_at AND s.ends_at AND O.COUNTRY = 'BR'
      
  LEFT JOIN (SELECT RT_ID, EMAIL, SK.TRANSPORT_MEDIA_TYPE AS VEHICLE, SK.CITY
FROM BR_PG_MS_RT_REGISTRATION_PUBLIC.STOREKEEPER_REQUEST SKR
LEFT JOIN BR_PG_MS_RT_REGISTRATION_PUBLIC.APPLICANT_USER AU
ON SKR.APPLICANT_USER_ID = AU.ID
LEFT JOIN BR_PG_MS_STOREKEEPERS_PUBLIC.storekeepers_ofuscated SK 
ON SK.ID = RT_ID
WHERE RT_ID IS NOT NULL) AS EMAIL
      ON RT_ID = D.STOREKEEPER_ID
WHERE
	o.created_at::DATE >= '2020-10-05'
	AND o.order_state IN ('finished', 'pending_review')
    AND LEVEL = 'diamond'
    AND VEHICLE IN ('car','motorbike')
    AND WEEK >= '2021-02-01'
 ) ORDER BY WEEK DESC
