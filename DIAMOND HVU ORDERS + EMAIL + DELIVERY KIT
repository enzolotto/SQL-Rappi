SELECT DISTINCT SK.ID, SK.HAS_DELIVERY_KIT, SK.CITY, SK.TRANSPORT_MEDIA_TYPE, EMAIL, D.LEVEL
FROM MX_PG_MS_STOREKEEPERS_PUBLIC.storekeepers_ofuscated SK 
  JOIN (SELECT distinct
       week,
       LEVEL,
       transport_media_type,
       city,
       storekeeper_id
FROM (SELECT
  DATE_TRUNC('week', o.created_at::DATE) AS week,
  o.order_id,
  o.country,
  d.storekeeper_id,
  IFNULL(s.level_name, 'rookie') AS level,
    s.transport_media_type,
    s.city
FROM
  global_finances.global_orders o
  JOIN global_finances.global_order_details d
  ON o.order_id = d.order_id AND o.country = d.country
  LEFT JOIN (
SELECT
      'MX' AS country,
      s.storekeeper_id,
      s.created_at::TIMESTAMP_NTZ AS starts_at,
      LEAD(starts_at, 1, CURRENT_TIMESTAMP::TIMESTAMP_NTZ) OVER (PARTITION BY s.storekeeper_id ORDER BY s.created_at) AS ends_at,
      l.level_name,
            sk.transport_media_type,
            sk.city
    FROM MX_pg_ms_sk_score_history_public.sk_level s
        LEFT JOIN MX_pg_ms_sk_score_history_public.level l
        ON s.level_id = l.id
        LEFT JOIN MX_PG_MS_STOREKEEPERS_PUBLIC.storekeepers_ofuscated SK
        ON sk.id = s.storekeeper_id
    QUALIFY
      ends_at::DATE >= '2020-12-28') s ON o.country = s.country AND d.storekeeper_id = s.storekeeper_id AND o.created_at::TIMESTAMP_NTZ BETWEEN s.starts_at AND s.ends_at
WHERE
  o.created_at::DATE >= '2020-12-28'
  AND o.order_state IN ('finished', 'pending_review')
    AND O.COUNTRY = 'MX'
 ) 
 WHERE  LEVEL = 'diamond'
-- AND CITY IN ('Belo Horizonte','Sao Paulo','Rio de Janeiro')
-- GROUP BY 1,2,3
   
) d ON D.STOREKEEPER_ID = SK.ID
JOIN (SELECT RT_ID, EMAIL
FROM MX_PG_MS_RT_REGISTRATION_PUBLIC.STOREKEEPER_REQUEST SKR
LEFT JOIN MX_PG_MS_RT_REGISTRATION_PUBLIC.APPLICANT_USER AU
ON SKR.APPLICANT_USER_ID = AU.ID) E 
ON E.RT_ID = D.STOREKEEPER_ID


WHERE SK.ID IN (105980,94223,268594,62482,189865,166343,121693,89026,81284,304389,210714,82065,103853,263189,104615,84697,144700,80527,87108,191459,354430,103262,374093,105140,372573,332828,175691,135827,328259,140954,351536,252259,221010,339569,307525,83253,423306,61330,155668,79087,291443,290131,27546,340118,346705,263605,104110,326442,303639,335040,379070,102938,415912,175997,79396,242075,122774,224320,357925,112202,313354,425063,264903,113382,408776,380557,123330,104010,389719,103309,412245,228162,63583,234169,341384,54055,106249,109457,162295,360156,244741,412061,285328,60439,313889,25570,222465,190110,55557,157957,140918,175706,378595,117399,182332,280877,101147,115647,106099,403962,129876,92056,415981,358009,234044,199978,406670,224744,416691,323999,150345,329956,44855,386018,245968,245697,120156,358692,186151,428212,403288,214595,202779,352054,54454,272038,413103,406588,104586,402777,372955,83933,397761,137849,218637,363182,117778,407104,200522,383179,146495,175934,313259,385231,409774,354788,423292,56880,98725,372332,416997,347224,403589,392062,358307,27519,359845,166305,133601,367451,367606,289112,356439,426113,276530,310166,315038,271308,317656,177781,180884,321787,264745,143117,50472,201543,221810,401369,111295,386310,421258,430718,375098,98513,63204,400142,203073,404159,410886,415739,157057,439934,413123,55207,400300,312920,419750,344728,75037,277021,314963,154437,328184,431469,380040,407479,389189,52531,413045,407216,98982,407106,307574,398764,419667,308867,169515,414658,331091,320288,412592,403731,376397,401904,331412,271967,333853,339520,255841,203075,402382,337490,439557,410751,114920,262671,188262,158501,426025,423377,412658,420713,338560,416515,276255,107497,167727,404901,404111,402706,403416,393582,95286,349751,410750,331295,330308,408952,427977,398876,293285,218343,366639,421384,107900,296361,426154,414112,218168,412913,410474,252934,182759,410596,406139,126828,207321,406775,424886,429114,180978,323888,395866,401089,428937,366838,414324,155448,54879,436239,306978,408717,428217,141882,336208,346548,427349,398086,369779,418788,418978,411526,202269,426604,411208,386431,100334,425114,380401,85155,402568,231718,223295,413859,322702,298417,410046,427484,199102,400232,332360,421027,233462,167185,402724,366237,416804,314586,403198,389662,322848,341428,378334,140280,324400,286617,280871,427155,403632,372656,246799,439275,219043,410302,180454,162104,428819,427143,169771,424924,427022,426765,437325,143244,408967,424912,421425,415733,403393,425607,378574,418564,423996,168258,415710,405913,427805,322237,251898,82685,429819,335417,428838,294833,418206,428989,439554,431537,431431,259965,438103,107949,397423,433273,236677,406863,403306,375310,396559,431003,417804,434168,373916,430599,405635,359290,405752,386598,424209,417400,423033,432211,411156,421201,433697,104144,350037,428092,182437,131587,426724,346552,401188,430610,419089,422565,424074,425564,412630,417782,427915,384863,431152,59347,426104,425269,422732,423356,353108,432438,318926,419580,352650,398217,413840,245365,433205,406626,286846,420748,392845,415490,97395,395686,410240,147129,163737,425646,373133,203522,424103,426263,432609,319530,334497,428173,154177,389202,405765,424139,408537,423407,405749,185231,90428,391512)
