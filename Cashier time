--no_cache
(select
      om.city
    , om.sub_group
    , date_trunc('day', order_date)::date as dates
    , OM.PICKER_TYPE
    , count(distinct b.order_id) as num_orders
    , round(avg (time_in_cashier),0) as avg_time_in_cashier
    , ROUND(LAG(AVG_TIME_IN_CASHIER,4) OVER (PARTITION BY OM.CITY ORDER BY DATEs),0) AS AVG_CASHIER_TIME_MINUS_4_DAYS
from
(select os.order_id
    , os.order_date
    , os.was_taken
    , os.products_qty
    , os.store_type
    , max(case when e.name in ('product_checked','picking_finished') and e.created_at::date = os.order_date::date then e.created_at else null end) as time_0 
    , min(case when e.name in ('bill_validated','hand_to_domiciliary', 'order_received_by_sk','bill_reported') and e.created_at::date = os.order_date::date then e.created_at else null end) as time_1
    , datediff(minute, time_0, time_1) as time_in_cashier
    from 
    (select
      os.order_id
      , created_at::date as order_date
      , was_taken
      , products_qty
          , store_type
    from BR_PG_MS_CPGOPS_ORDERS_MS_PUBLIC.ORDER_SUMMARY os
      where created_at::date >= dateadd(week, -10, current_date)::date
      and (store_type IN ('market'))
      and (storekeeper_type in ('rappitendero'))
      and (state in ('finished','pending_review'))
   --   and (os.physical_store_id='276')
    ) as os
    join BR_pg_ms_cpgops_events_ms_public.order_events as e on os.order_id = e.order_id
      where e.created_at::date >= dateadd(week, -10, current_date)::date
      group by 1, 2, 3, 4, 5
    ) as b
 join co_writable.gortallordersmaster om on om.order_id = b.order_id and om.country = 'BR' and om.sub_group = 'Super' AND PICKER_TYPE = 'RT' AND OM.UNITS_QTY > 20
 left join br_grability_public.storekeepers_ofuscated sk on (om.storekeeper_id) = sk.id and transport_media_type = 'car'
  where 1 = 1
-- and type not in ('SHOPPER')
  group by 1, 2, 3, 4
  having avg_time_in_cashier > 0
  order by dates desc)
--select * from BR_PG_MS_CPGOPS_ORDERS_MS_PUBLIC.ORDER_SUMMARY os where os.physical_store_id = 276 limit 200
