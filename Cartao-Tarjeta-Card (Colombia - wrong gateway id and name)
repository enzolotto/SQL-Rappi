--DIFERENÇA ENTRE CRIAÇÃO DE CONTA DE RT E CRIAÇÃO DA CONTA EM SI 
SELECT DISTINCT 
SK.ID AS RT_ID,
'CO' AS COUNTRY,
SK.CITY,
SK.TRANSPORT_MEDIA_TYPE AS VEHICLE,
AO.IS_ACTIVE AS ACTIVE_ACCOUNT,
AO.GATEWAY_ID,
G.NAME,
CASE WHEN AO.GATEWAY_ID = 12 AND AO.IS_ACTIVE = 'TRUE' THEN 'HAS GLOBAL DISPERSION' 
     WHEN AO.GATEWAY_ID = 1 AND AO.IS_ACTIVE = 'TRUE' THEN 'HAS EDENRED' 
     WHEN AO.GATEWAY_ID = 12 AND AO.IS_ACTIVE = 'FALSE' THEN 'INACTIVE GLOBAL DISPERSION' 
     WHEN AO.GATEWAY_ID = 1 AND AO.IS_ACTIVE = 'FALSE' THEN 'INACTIVE EDENRED'
     WHEN AO.GATEWAY_ID = 9 AND AO.IS_ACTIVE = 'TRUE' THEN 'ACTIVE RAPPIPAY PRODUCTS'
     WHEN AO.GATEWAY_ID = 9 AND AO.IS_ACTIVE = 'FALSE' THEN 'INACTIVE RAPPIPAY PRODUCTS'

    ELSE 'NO CARD' END AS HAS_CARD,
SK.CREATED_AT::DATE AS SK_CREATION,
AO.CREATED_AT::DATE AS ACCOUNT_CREATION,
TA.CREATED_AT::DATE AS TRANSACTION_ACCOUNT_CREATION,
CASE WHEN datediff(DAY,SK_CREATION,CURRENT_DATE::DATE)<7 THEN 'NEW RT (<7 DAYS)'
           ELSE 'OLD RT (>7 DAYS)' END AS RT_TYPE,
datediff(DAY,SK_CREATION,ACCOUNT_CREATION) AS DIFF_SK_ACCOUNT_CREATION,
datediff(DAY,SK_CREATION,TRANSACTION_ACCOUNT_CREATION) AS DIFF_SK_TA_CREATION,
COUNT (DISTINCT O.ID) AS TOTAL_ORDERS,
MAX (O.CREATED_AT::DATE) AS LAST_ORDER_FECHA
from CO_PG_MS_STOREKEEPERS_PUBLIC.storekeepers_ofuscated SK  
LEFT JOIN CO_pg_ms_storekeeper_accounts_public.accounts_ofuscated AO ON SK.ID = AO.USER_ID AND SK.IS_ACTIVE = 'TRUE'
JOIN CO_CORE_ORDERS_PUBLIC.ORDERS_vw O ON COALESCE(O.STOREKEEPER_ID,O.DELIVERYBOY_ID) = SK. ID AND O.STATE IN ('finished','pending_review')
LEFT JOIN CO_pg_ms_storekeeper_accounts_public.transaction_accounts TA ON TA.ACCOUNT = AO.ACCOUNT AND TA.ACTION = 'create'
LEFT JOIN CO_pg_ms_storekeeper_accounts_public.gateways g on g.id = ao.gateway_id 

WHERE VEHICLE NOT IN ('neither')
GROUP BY 1,2,3,4,5,6,7,8,9,10,11

HAVING DATEDIFF(DAY, LAST_ORDER_FECHA, CURRENT_DATE) <29

ORDER BY ACCOUNT_CREATION DESC

--SELECT * FROM CO_pg_ms_storekeeper_accounts_public.transaction_accounts LIMIT 100
