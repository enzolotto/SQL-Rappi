(
  with pilot_orders as (
select
  os.order_id
  , os.store_id
  , os.total_value
  , os.was_taken
  , os.tag
  , os.total_products_price
  , coalesce(o.place_at,o.created_at) created_at
  , o.state
  , ord.vertical_sub_group as vertical
  , so.transport_media_type as vehicle
from br_PG_MS_CPGOPS_ORDERS_MS_PUBLIC.ORDER_SUMMARY os
  join br_core_orders_public.orders_vw o on o.id=os.order_id
join br_grability_public.storekeepers_ofuscated so on o.storekeeper_id = so.id
    AND So.ID IN (972805,678508,895326,942169,912962,651943,883195,859563,156854,938167,951220,963909,940349,795283,856700,623115,948375,725943,830462,
                898334,889805,977725,882003,772155,627963,884584,743514,570648,977461,451490,739586,514963,866690,962283,649942,419675,950535,867140,
                679691,980992,794752,976538,875170,851562,969994,814679,668089,508709,881705,506925,834303,965502,973900,868609,976065,950805,385384,
                917661,960806,867000,858560,976907,765691,639855,647324,655983,629767,959657,946046,582065,944656,848180,978493,785533,976031,872536,
                804511,980517,371151,925640,956052,901198,961991,415860,594641,702890,759753,950726,945553,971698,939435,944689,871484,946735,868751,
                942610,941682,953719,965235,985103,885121,940534,958267,989265,785643,768230,702273,620337,940183,818586,932740,935361,528877,922106,
                903601,817706,868419,961744,961848,974269,935815,660155,965921,933071,718792,798597,704182,879509,802316,907865,963647,832198,846849,
                376028,978948,924448,933011,736745,845539,868983,984241,896137,446572,484915,976452,989941,709051,925265,967989,946446,152634,928679,
                372728,337631,580974,853835,599244,889964,824482,535635,610514,559711,800767,407515,882180,788068,557350,214322,169579,740271,641309,
                681852,294011,287532,333709,191068,766339,955870,703049,749253,938779,303584,478229,652061,815809,424546,861376,500975,954104,264026,
                460025,284632,405995,303421,837985,354422,884332,855599,619919,339009,277106,827738,875051,878365,758813,623294,818673,823763,889368,
                601146,294961,742883,538625,715409,567716,178895,643794,947495,805547,925094,153614,337169,417097,871879,515260,632255,566309,49164,
                846174,342502,613281,118226,126519,883975,603429,240817,525164,830018,169093,178541,809792,908690,842287,850088,492784,841735,461567,
                759534,365085,966461,343717,783192,764995,755801,530835,666273,192059,529163,911858,697854,69695,874273,718325,950469,415506,757920,
                176334,598532,647959,667534,90080,955885,690016,568170,555267,467271,867340,889180,120881,76856,245223,976128,75107,813094,404411,
                79448,822743,737820,398512,191004,828968,804702,848789,810116,290848,430974,123848,944982,921429,686265,961300,518744,489267,686193,
                922172,132307,897100,243532,361641,627344,622579,150290,732799,407324,498768,602584,353299,934315,376416,137218,895937,701206,829079,
                493054,495045,954494,510713,199538,826093,41070,435594,279361,727627,352598,821532,806477,787641,572611,880602,397053,75529,617800,
                862449,781240,889696,446745,695330,911350,782825,204556,330808,536717,812213,174909,819570,46966,968698,637953,809421,397210,656673,
                708841,870812,621819,815294,738852,69262,428086,825225,843539,171225,947189,326841,853862,486421,774089,689026,859467,817472,97839,
                947350,745271,737967,924888,852195,517449,914634,196454,390776,804009,822597,961624,281109,911029,343580,247230,51644,103875,590862,
                737738,957446,911165,479063,974515,275316,870456,422493,795819,528976,655513,310035,863236,872591,513749,964271,71265,218197,426420,
                297109,202416,223440,393909,937221,973645,895898,882903,425182,824572,903184,938539,849794,154569,140892,954708,385161,409586,467472,
                912610,413718,711667,898406,715039,807237,787644,353702,808895,601998,944410,803429,101282,917898,798105,389691,815107,822367,947086,
                369662,539135,762794,797029,969217,970253,462809,167810,275416,894884,531344,947596,857110,292205,76414,676582,905579,219285,801425,
                938964,608339,503410,697856,941805,743707,664077,896175,856208,894702,235026,744136,411972,844826,493988,315571,856714,974345,302726,
                910244,824735,669925,956420,617061,232203,964010,968457,330188,671721,448071,895219,729151,353461,878723,970086,340445,939006,376951,
                859762,195572,220979,162025,168913,669066,135032,954283,210410,754845,802801,964711,618763,242885,233551,551926,284076,744659,502794,
                855822,815299,452943,601224,581136,340451,928423,897276,967076,700977,971247,460959,709066,875095,565245,224405,712006,808509,941582,
                679874,119764,43392,941434,50646,875913,942815,705404,442487,228531,809159,737898,808324,519001,105924,87241,63881,755675,146205,939088,
                743860,89186,282709,968743,797999,830819,966615,44868,936690,967043,651369,404631,449175,347203,889978,772763,638763,663261,157635,860733,
                922129,272632,177357,925174,522977,687965,753739,515231,126290,647494,879293,386258,821719,375000,86199,960573,972436,352425,990843,412615,
                762493,118987,199236,39694,616658,763562,277189,597400,387740,945825,604813,206684,786890,963016,969916,935234,933699,744146,366501,233222,
                774313,624107,766337,211698,948964,121979,454978,975860,255548,589043,895339,597129,796357,504988,165655,952002,632885,476082,556845,366746,
                740050,463623,725800,844745,727059,711201,447847,269880,93478,811830,895622,386290,775831,194235,518798,370530,141773,799413,664656,214468,
                696098,947821,248199,764241,838281,958371,719572,686840,520096,552949,687629,771133,345645,342888,491583,345724,384808,548230,777257,331669,
                174661,140405,939069,583419,466281,833698,558389,191032,904933,178730,854158,284962,660559,287872,309455,722599,183198,223010,849608,605539,
                275531,249733,361170,683120,379647,863714,607932,297360,820748,172725,680678,400126,370931,802952,776334,377270,376034,912286,522177,399736,
                890575,322978,945252,864230,820587,690375,753743,357295,394694,845313,961922,516565,370296,758957,377527,86457,590058,89170,577750,224725,
                522120,887998,597174,611477,450609,605141,775704,221317,869053,542149,443088,407175,862196,869768,680017,711724,700430,680184,719978,583235,
                749075,639915,321338,741788,633440,635782,890586,375444,57569,853778,500190,597974,498838,281807,851069,704664,964596,82264,787205,161477,
                805911,671092,816532,178566,938504,819126,496227,906694,975567,844289,728971,800195,526350,177153,726147,352758,780940,318635,700233,716727,
                162143,730584,919585,859840,859730,131271,572411,664292,768993,764733,729469,874826,739402,647711,372227,968938,499110,702014,875119,159139,
                871795,104065,942102,713935,644067,155077,588415,337646,382402,885482,704796,755837,252362,710376,639768,455149,669278,323157,711712,527555,
                624691,661054,942981,107250,868674,220056,528925,888083,64310,749781,850954,452425,837331,340478,205320,607281,843192,390533,912806,191057,
                763695,145977,252345,957512,692402,784849,844731,864921,706388,867445,351771,497486,317977,585911,765211,471571,934163,500857,98867,623884,
                475589,141840,302369,141713,944077,881386,180420,945068,100702,756013,471351,460540,229281,110001,592264,75782,434891,113777,251052,602417,
                781928,446489,942982,126411,776279,874262,743686,955169,674660,582887,473225,277002,130682,499761,672992,584248,969117,688109,883461,815200,
                782625,574723,885342,289325,862686,122319,860524,501885,119309,948901,944265,501384,647229,227190,983828,180217,966515,929220,891695,881400,
                854961,316867,946683,902208,823898,73078,951229,827322,833645,501552,899222,217770,693382,86428,925806,180159,824860,756557,54810,558168,
                247492,79978,655440,794606,491363,698961,750700,902831,451147,333410,233886,913264,150848,753025,242154,151526,100790,394948,370643,942262,
                230672,232263,79642,771906,248153,952611,860009,486056,552330,880429,540687,679215,247919,831987,867798,83170,187924,959767,458001,582432,
                756643,730692,859719,767923,875703,699164,422714,949715,935791,186924,817569,906544,452143,772560,927029,427554,866048,625384,458930,856304,
                872750,867022,876887,881206,648489,864036,289015,875427,90336,139329,814214,71460,98052,143877,812970,691002,891864,647821,624339,549776,
                789811,888134,808407,821879,438156,361071,608670,736070,971226,101356,891728,810321,908141,557354,156735,788903,809741,801096,441496,895715,
                137173,746384,188266,281459,230583,142001,74659,141228,799975,840246,865974,863827,673749,832433,438418,763739,610011,934339,95168,890455,
                934238,74231,971967,895122,610867,555698,649488,475695,860424,837544,270967,768126,772607,398935,60284,835234,458935,404570,293742,271134,
                177901,966777,798252,979154,595551,421889,212374,590265,834438,230464,213005,546668,442790,853790,821491,880845,459844,113912,430743,950503,
                892347,443296,934177,949096,794243,823332,256048,969862,357017,302655,746177,585616,830043,598250,484236,807248,197403,904613,783156)
  join global_finances.br_orders as ord on ord.order_id = os.order_id
where 1=1
  and os.created_at::date >= current_date - interval '10w'
  --and (os.store_type IN ('express_picker','express','market'))
  and coalesce(o.place_at,o.created_at) >= current_date - interval '10w'
)



, cancelled_orders as (
select
  po.order_id
  , po.created_at
  , po.tag
  , max(case when om.type in ('assign_to_shopper','taken_visible_order') then om.created_at else null end) as assigned_at
  , max(case when om.type ilike '%cancel%' then om.created_at else null end) as canceled_at
from pilot_orders po
-- join br_core_orders_public.orders_vw o
join br_core_orders_public.order_modifications_vw as om
  on om.order_id = po.order_id
where 1=1
  and po.state ilike '%cancel%'
  and po.state not in (  'canceled_by_fraud'
                        ,'canceled_for_payment_error'
                        ,'canceled_by_partner_inactivity'
                        ,'canceled_partner_order_refused'
                        ,'canceled_by_split_error'
                        ,'canceled_by_timeout'
                        ,'canceled_partner_order_refused'
                        ,'canceled_partner_after_take'
                      )
  and om.created_at >= current_date - interval '10w'
  --don't count early_cancellations
  group by 1,2,3
having datediff(minute, assigned_at, canceled_at) > 7
-- order by 2 
),
------------------CANCELLATION INFO------------------------

----------FINAL RESULT----------
final as (select
  'BR' as country,
  date_trunc(day, po.created_at::date) as dateS
 -- , po.was_taken
  , vertical
  , vehicle
--   , co.order_id
  , count(distinct po.order_id) as total_orders
  , count(distinct co.order_id) as orders_cancelled
  , orders_cancelled/total_orders Perc_Canceled
from pilot_orders po
-- join ubicacion u
--   on u.id = po.order_id
left join cancelled_orders co
  on po.order_id = co.order_id
where 1=1
    -- and vertical IN ('SUPER','HIPER')
    -- and datediff(week, date, current_date) >=1

group by 1,2,3,4
order by 2 desc )

SELECT DATES, VEHICLE, AVG(Perc_Canceled) AS AVG_CR
FROM FINAL
  GROUP BY 1,2

)
